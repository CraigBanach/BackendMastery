name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # Detect what changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend-changed }}
      frontend-changed: ${{ steps.changes.outputs.frontend-changed }}
      workflows-changed: ${{ steps.changes.outputs.workflows-changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect Changes
        uses: ./.github/actions/detect-changes
        id: changes

  # Build backend (if changed)
  backend:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.backend-changed == 'true' || needs.detect-changes.outputs.workflows-changed == 'true'
    uses: ./.github/workflows/_backend-build.yml
    with:
      push-image: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets: inherit

  # Build frontend (if changed)
  frontend:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend-changed == 'true' || needs.detect-changes.outputs.workflows-changed == 'true'
    uses: ./.github/workflows/_frontend-build.yml
    with:
      push-image: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets: inherit

  # Deploy to GitOps repository
  deploy:
    runs-on: ubuntu-latest
    needs: [detect-changes, backend, frontend]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' && 
      (needs.backend.outputs.success == 'true' || needs.frontend.outputs.success == 'true')
    
    steps:
      - name: Update GitOps deployment configuration
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Debug: Check token and permissions
          echo "ðŸ” Debugging GitOps deployment..."
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Current repository: ${{ github.repository }}"
          echo "Token length: ${#GITHUB_TOKEN}"
          echo "Actor: ${{ github.actor }}"
          
          # Test repository access first
          echo "ðŸ“¡ Testing repository access..."
          REPO_INFO=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository_owner }}/personifi-deployments)
          
          echo "Repository exists: $(echo "$REPO_INFO" | jq -r '.name // "NOT FOUND"')"
          echo "Repository visibility: $(echo "$REPO_INFO" | jq -r '.visibility // "unknown"')"
          echo "Repository private: $(echo "$REPO_INFO" | jq -r '.private // "unknown"')"
          echo "Permissions: $(echo "$REPO_INFO" | jq -r '.permissions // "No permissions"')"
          
          # Try without authentication first (should work for public repos)
          echo "ðŸ”“ Testing public access without token..."
          curl -s https://api.github.com/repos/${{ github.repository_owner }}/personifi-deployments | jq -r '.name // "Public access failed"'
          
          # Configure git with explicit token
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Try multiple clone approaches
          echo "ðŸ“¥ Attempting to clone deployment repository..."
          
          # Method 1: Direct clone with token
          echo "Method 1: Clone with token in URL..."
          if git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository_owner }}/personifi-deployments.git; then
            echo "âœ… Clone with token succeeded"
            cd personifi-deployments
          else
            echo "âŒ Clone with token failed, trying public clone..."
            # Method 2: Public clone (for public repos)
            if git clone https://github.com/${{ github.repository_owner }}/personifi-deployments.git; then
              echo "âœ… Public clone succeeded"
              cd personifi-deployments
              # Configure token for push operations
              git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository_owner }}/personifi-deployments.git
            else
              echo "âŒ All clone methods failed"
              exit 1
            fi
          fi
          
          # Get current images from deployment.env
          if [ -f deployment.env ]; then
            source deployment.env
            CURRENT_BACKEND_IMAGE="$BACKEND_IMAGE"
            CURRENT_FRONTEND_IMAGE="$FRONTEND_IMAGE"
          else
            CURRENT_BACKEND_IMAGE="ghcr.io/craigbanach/personifibackend:latest"
            CURRENT_FRONTEND_IMAGE="ghcr.io/craigbanach/personifi-app:latest"
          fi
          
          # Update with new images (if they were built)
          NEW_BACKEND_IMAGE="$CURRENT_BACKEND_IMAGE"
          NEW_FRONTEND_IMAGE="$CURRENT_FRONTEND_IMAGE"
          CHANGES_SUMMARY=""
          
          # Update backend image if it was built
          if [ "${{ needs.backend.outputs.success }}" = "true" ] && [ "${{ needs.backend.outputs.image-tag }}" != "not-built" ]; then
            NEW_BACKEND_IMAGE="${{ needs.backend.outputs.image-tag }}"
            CHANGES_SUMMARY="${CHANGES_SUMMARY}ðŸš€ Backend: $NEW_BACKEND_IMAGE"$'\n'
          fi
          
          # Update frontend image if it was built
          if [ "${{ needs.frontend.outputs.success }}" = "true" ] && [ "${{ needs.frontend.outputs.image-tag }}" != "not-built" ]; then
            NEW_FRONTEND_IMAGE="${{ needs.frontend.outputs.image-tag }}"
            CHANGES_SUMMARY="${CHANGES_SUMMARY}ðŸŽ¨ Frontend: $NEW_FRONTEND_IMAGE"$'\n'
          fi
          
          # Write updated deployment.env
          cat > deployment.env << EOF
          # Personifi Deployment Configuration
          # Updated by GitHub Actions - Build ${{ github.run_number }}
          
          BACKEND_IMAGE=$NEW_BACKEND_IMAGE
          FRONTEND_IMAGE=$NEW_FRONTEND_IMAGE
          DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=${{ github.sha }}
          DEPLOYMENT_VERSION=${{ github.run_number }}
          BUILD_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          
          # Commit and push changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add deployment.env
          
          git commit -m "ðŸš€ Deploy build ${{ github.run_number }} ($(echo "${{ github.sha }}" | cut -c1-7))

          $CHANGES_SUMMARY
          Triggered by: ${{ github.actor }}
          Build: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push
          
          echo "âœ… GitOps deployment configuration updated"
          echo -e "$CHANGES_SUMMARY"

  # Comment on PRs with build results
  comment-pr:
    runs-on: ubuntu-latest
    needs: [detect-changes, backend, frontend]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: Comment PR with build results
        uses: actions/github-script@v7
        with:
          script: |
            const backendChanged = '${{ needs.detect-changes.outputs.backend-changed }}' === 'true';
            const frontendChanged = '${{ needs.detect-changes.outputs.frontend-changed }}' === 'true';
            const workflowsChanged = '${{ needs.detect-changes.outputs.workflows-changed }}' === 'true';
            
            const backendResult = '${{ needs.backend.result }}';
            const frontendResult = '${{ needs.frontend.result }}';
            
            let summary = '## ðŸ”¨ Build Results\n\n';
            
            // Backend status
            if (backendChanged || workflowsChanged) {
              if (backendResult === 'success') {
                summary += 'âœ… **Backend**: Tests passed, build successful\n';
              } else if (backendResult === 'failure') {
                summary += 'âŒ **Backend**: Tests failed or build failed\n';
              } else if (backendResult === 'cancelled') {
                summary += 'ðŸš« **Backend**: Build was cancelled\n';
              } else {
                summary += 'âš ï¸ **Backend**: Build was skipped\n';
              }
            } else {
              summary += 'â­ï¸ **Backend**: No changes detected\n';
            }
            
            // Frontend status
            if (frontendChanged || workflowsChanged) {
              if (frontendResult === 'success') {
                summary += 'âœ… **Frontend**: Lint passed, build successful\n';
              } else if (frontendResult === 'failure') {
                summary += 'âŒ **Frontend**: Lint failed or build failed\n';
              } else if (frontendResult === 'cancelled') {
                summary += 'ðŸš« **Frontend**: Build was cancelled\n';
              } else {
                summary += 'âš ï¸ **Frontend**: Build was skipped\n';
              }
            } else {
              summary += 'â­ï¸ **Frontend**: No changes detected\n';
            }
            
            // Add workflow changes note
            if (workflowsChanged) {
              summary += '\nðŸ“ **Note**: Workflow files changed - both services tested\n';
            }
            
            // Build info
            summary += `\n**Build ID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            summary += '\n\n---\n*Automated build results from CI/CD pipeline*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });